<!DOCTYPE html>
<html>
<head>
    <title>‚úÖ Confirm Parsed Part</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .header { background: #28a745; color: white; padding: 15px; margin: -20px -20px 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        .form-container { background: white; padding: 30px; border-radius: 5px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #2c3e50; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 3px; }
        input:focus, select:focus, textarea:focus { border-color: #28a745; outline: none; }
        .required { color: #e74c3c; }
        .form-actions { text-align: center; margin-top: 30px; }
        .btn { padding: 12px 24px; margin: 0 10px; border: none; border-radius: 3px; cursor: pointer; font-size: 14px; text-decoration: none; display: inline-block; }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #218838; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #545b62; }
        .parsed-data { background: #e8f5e8; padding: 15px; border-radius: 5px; margin-bottom: 20px; border-left: 4px solid #28a745; }
        .fitments-preview { background: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 15px; }
        .fitments-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .fitments-table th, .fitments-table td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 12px; }
        .fitments-table th { background: #f8f9fa; }
        .messages { margin-bottom: 20px; }
        .messages div { padding: 10px; border-radius: 3px; margin-bottom: 5px; }
        .messages .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .messages .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .raw-text-preview { background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px; border: 1px solid #dee2e6; }
        .raw-text-content { font-family: 'Courier New', monospace; font-size: 11px; white-space: pre-wrap; max-height: 200px; overflow-y: auto; }
        .confidence-indicator { float: right; font-size: 12px; padding: 4px 8px; border-radius: 3px; }
        .confidence-high { background: #d4edda; color: #155724; }
        .confidence-medium { background: #fff3cd; color: #856404; }
        .confidence-low { background: #f8d7da; color: #721c24; }
        .field-row { display: flex; gap: 15px; }
        .field-row .form-group { flex: 1; }
        .toggle-section { cursor: pointer; user-select: none; }
        .toggle-section:hover { background: #f8f9fa; }
        .collapsible { display: none; }
        .collapsible.show { display: block; }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>‚úÖ Confirm Parsed Part Data</h1>
            <p>Review and edit the extracted information before creating the part</p>
        </div>
    </div>
    
    <div class="container">
        {% if messages %}
        <div class="messages">
            {% for message in messages %}
            <div class="{{ message.tags }}">{{ message }}</div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Raw Text Preview (Collapsible) -->
        <div class="raw-text-preview">
            <div class="toggle-section" onclick="toggleSection('raw-text')">
                <h3>üìÑ Original Text <small>(click to expand)</small></h3>
            </div>
            <div id="raw-text" class="collapsible">
                <div class="raw-text-content">{{ raw_text }}</div>
            </div>
        </div>

        <!-- Parsed Data Summary -->
        <div class="parsed-data">
            <h3>ü§ñ AI Extraction Results</h3>
            <div class="field-row">
                <div><strong>Part Name:</strong> {{ parsed_data.part_name }}
                    <span class="confidence-indicator confidence-{{ parsed_data.confidence.part_name }}">
                        {{ parsed_data.confidence.part_name|title }} Confidence
                    </span>
                </div>
            </div>
            <div class="field-row">
                <div><strong>Part Number:</strong> {{ parsed_data.part_number }}
                    <span class="confidence-indicator confidence-{{ parsed_data.confidence.part_number }}">
                        {{ parsed_data.confidence.part_number|title }} Confidence
                    </span>
                </div>
                <div><strong>Manufacturer:</strong> {{ parsed_data.manufacturer }}
                    <span class="confidence-indicator confidence-{{ parsed_data.confidence.manufacturer }}">
                        {{ parsed_data.confidence.manufacturer|title }} Confidence
                    </span>
                </div>
            </div>
            <div><strong>Suggested Category:</strong> {{ parsed_data.category }}</div>
            {% if parsed_data.fitments %}
            <div><strong>Fitments Found:</strong> {{ parsed_data.fitments|length }} vehicles</div>
            {% endif %}
        </div>

        <!-- Edit Form -->
        <form method="post" class="form-container">
            {% csrf_token %}
            
            <h3>üìù Edit Part Information</h3>
            
            <div class="field-row">
                <div class="form-group">
                    <label for="manufacturer">Manufacturer <span class="required">*</span></label>
                    <select name="manufacturer" id="manufacturer" required>
                        <option value="">Select Manufacturer...</option>
                        {% for mfg in manufacturers %}
                        <option value="{{ mfg.id }}" {% if mfg.name == parsed_data.manufacturer or mfg.abbreviation == parsed_data.manufacturer %}selected{% endif %}>
                            {{ mfg.abbreviation }} - {{ mfg.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="part_number">Part Number <span class="required">*</span></label>
                    <input type="text" name="part_number" id="part_number" value="{{ parsed_data.part_number }}" required>
                </div>
            </div>

            <div class="form-group">
                <label for="name">Part Name <span class="required">*</span></label>
                <input type="text" name="name" id="name" value="{{ parsed_data.part_name }}" required>
            </div>

            <div class="form-group">
                <label for="category">Category <span class="required">*</span></label>
                <select name="category" id="category" required>
                    <option value="">Select Category...</option>
                    {% for cat in categories %}
                    <option value="{{ cat.id }}" {% if cat.name == parsed_data.category %}selected{% endif %}>
                        {{ cat.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="description">Description</label>
                <textarea name="description" id="description" rows="3">{{ parsed_data.description }}</textarea>
            </div>

            <div class="field-row">
                <div class="form-group">
                    <label for="weight">Weight (lbs)</label>
                    <input type="number" name="weight" id="weight" step="0.01" value="{{ parsed_data.weight }}">
                </div>
                <div class="form-group">
                    <label for="dimensions">Dimensions</label>
                    <input type="text" name="dimensions" id="dimensions" value="{{ parsed_data.dimensions }}">
                </div>
            </div>

            <!-- Fitments Section -->
            {% if parsed_data.fitments %}
            <div class="fitments-preview">
                <div class="toggle-section" onclick="toggleSection('fitments-section')">
                    <h3>üöó Vehicle Fitments ({{ parsed_data.fitments|length }} found) <small>(click to expand)</small></h3>
                </div>
                <div id="fitments-section" class="collapsible">
                    <p>The following vehicle fitments were detected and will be created automatically:</p>
                    <table class="fitments-table">
                        <thead>
                            <tr>
                                <th>Year</th>
                                <th>Make</th>
                                <th>Model</th>
                                <th>Trim</th>
                                <th>Engine</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for fitment in parsed_data.fitments %}
                            <tr>
                                <td>{{ fitment.year }}</td>
                                <td>{{ fitment.make }}</td>
                                <td>{{ fitment.model }}</td>
                                <td>{{ fitment.trim|default:"-" }}</td>
                                <td>{{ fitment.engine|default:"-" }}</td>
                                <td>{{ fitment.notes|default:"-" }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 15px;">
                        <label>
                            <input type="checkbox" name="create_fitments" value="true" checked>
                            Create vehicle fitments automatically
                        </label>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Additional Options -->
            <div class="form-group">
                <label>
                    <input type="checkbox" name="create_interchange" value="true" 
                           {% if parsed_data.suggested_interchanges %}checked{% endif %}>
                    Create interchange group for similar parts
                </label>
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" name="add_to_part_group" value="true"
                           {% if parsed_data.suggested_part_group %}checked{% endif %}>
                    Add to part group: {{ parsed_data.suggested_part_group|default:"Auto-detect" }}
                </label>
            </div>

            <!-- Hidden fields for parsed data -->
            <input type="hidden" name="parsed_fitments" value="{{ parsed_data.fitments_json }}">
            <input type="hidden" name="confidence_scores" value="{{ parsed_data.confidence_json }}">
            <input type="hidden" name="raw_text" value="{{ raw_text }}">

            <div class="form-actions">
                <button type="submit" name="action" value="create" class="btn btn-success">
                    ‚úÖ Create Part & Fitments
                </button>
                <button type="submit" name="action" value="create_part_only" class="btn btn-success" style="background: #6f42c1;">
                    üì¶ Create Part Only
                </button>
                <a href="{% url 'parts:smart_parser' %}" class="btn btn-secondary">
                    ‚¨ÖÔ∏è Back to Parser
                </a>
            </div>
        </form>

        <!-- AI Insights Section -->
        <div class="form-container">
            <div class="toggle-section" onclick="toggleSection('ai-insights')">
                <h3>üß† AI Parsing Insights <small>(click to expand)</small></h3>
            </div>
            <div id="ai-insights" class="collapsible">
                <div style="font-size: 13px; color: #6c757d;">
                    <h4>Confidence Scores:</h4>
                    <ul>
                        <li><strong>Part Name:</strong> {{ parsed_data.confidence.part_name|title }} ({{ parsed_data.confidence_scores.part_name }}%)</li>
                        <li><strong>Part Number:</strong> {{ parsed_data.confidence.part_number|title }} ({{ parsed_data.confidence_scores.part_number }}%)</li>
                        <li><strong>Manufacturer:</strong> {{ parsed_data.confidence.manufacturer|title }} ({{ parsed_data.confidence_scores.manufacturer }}%)</li>
                        <li><strong>Vehicle Fitments:</strong> {{ parsed_data.confidence.fitments|title }} ({{ parsed_data.confidence_scores.fitments }}%)</li>
                    </ul>
                    
                    {% if parsed_data.parsing_notes %}
                    <h4>Parsing Notes:</h4>
                    <ul>
                        {% for note in parsed_data.parsing_notes %}
                        <li>{{ note }}</li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                    
                    <h4>Extraction Method:</h4>
                    <p>{{ parsed_data.extraction_method|default:"Pattern matching and natural language processing" }}</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            section.classList.toggle('show');
        }

        // Auto-expand high-confidence sections
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-expand fitments if high confidence
            {% if parsed_data.confidence.fitments == 'high' %}
            document.getElementById('fitments-section').classList.add('show');
            {% endif %}
            
            // Highlight fields with low confidence
            const confidenceFields = {
                'part_number': '{{ parsed_data.confidence.part_number }}',
                'name': '{{ parsed_data.confidence.part_name }}',
                'manufacturer': '{{ parsed_data.confidence.manufacturer }}'
            };
            
            for (const [fieldId, confidence] of Object.entries(confidenceFields)) {
                const field = document.getElementById(fieldId);
                if (field && confidence === 'low') {
                    field.style.borderColor = '#dc3545';
                    field.style.backgroundColor = '#fff5f5';
                }
            }
        });

        // Form validation
        document.querySelector('form').addEventListener('submit', function(e) {
            const requiredFields = document.querySelectorAll('[required]');
            let isValid = true;
            
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    field.style.borderColor = '#dc3545';
                    isValid = false;
                } else {
                    field.style.borderColor = '#28a745';
                }
            });
            
            if (!isValid) {
                e.preventDefault();
                alert('Please fill in all required fields.');
            }
        });
    </script>
</body>
</html>
